{% extends 'base.html' %}
{% load widget_tweaks %}


{% load crispy_forms_tags %}

{% load static %}

{% block title %}
{% if object %}Modifier Achat {{ object.numero }}{% else %}Nouvel Achat{% endif %} - L' EXEMPLE SHOP
{% endblock %}

{% block extrahead %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="bi bi-{% if object %}pencil{% else %}plus-circle{% endif %}"></i>
        {% if object %}Modifier Achat {{ object.numero }}{% else %}Nouvel Achat{% endif %}
    </h1>
    <a href="{% url 'achats:list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Retour
    </a>
</div>

<form method="post" id="achatForm" class="modern-form">
    {% csrf_token %}
    
    <div class="row">
        <div class="col-md-8">
            <!-- Informations générales -->
            <div class="modern-card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0 p-2">
                        <i class="bi p-2 bi-info-circle" style="color: black;"></i> Informations Générales
                    </h5>
                </div>
                <div class="card-body p-3">
                    {{ form.fournisseur|as_crispy_field }}
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-success w-100" data-bs-toggle="modal" data-bs-target="#fournisseurModal">
                            <i class="bi bi-plus-circle"></i> Nouveau Fournisseur
                        </button>
                    </div>
            
                    <div class="row mt-3">
                        <div class="col-md-6">
                            {{ form.date_livraison|as_crispy_field }}
                        </div>
                        <div class="col-md-6">
                            {{ form.statut|as_crispy_field }}
                        </div>
                    </div>
            
                    <div class="mt-3">
                        {{ form.note|as_crispy_field }}
                    </div>
                </div>
            </div>
            
            
            <!-- Articles -->
            <div class="modern-card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center px-3">
                        <h5 class="card-title mb-0 p-2"><i class="bi bi-list-ul p-2" style="color: black;"></i> Articles</h5>
                        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#produitModal" style="color: black;">
                            <i class="bi bi-plus-circle" style="color: black;"></i> Nouveau Produit
                        </button>
                    </div>
                </div>
                <div class="card-body p-3">
                    {{ formset.management_form }}
                    <div id="formset-container">
                        {% for form in formset %}
                        <div class="formset-form border rounded p-3 mb-3 fade-in">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">{{ form.produit.label }}</label>
                                    {{ form.produit|add_class:"form-select" }}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">{{ form.quantite.label }}</label>
                                    {{ form.quantite|add_class:"form-control" }}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">{{ form.quantite_recue.label }}</label>
                                    {{ form.quantite_recue|add_class:"form-control" }}
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">{{ form.prix_unitaire.label }}</label>
                                    <div class="input-group">
                                        {{ form.prix_unitaire|add_class:"form-control" }}
                                        <span class="input-group-text">FCFA</span>
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label">Total</label>
                                    <input type="text" class="form-control total-item" readonly>
                                    {% if formset.can_delete %}
                                    <div class="form-check mt-2">
                                        {{ form.DELETE }}
                                        <label class="form-check-label text-danger">Supprimer</label>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {{ form.id }}
                        </div>
                        {% endfor %}
                    </div>
                    
                    <button type="button" id="add-form" class="btn btn-outline-primary mt-3">
                        <i class="bi bi-plus-circle" style="color: black;"></i> Ajouter un Article
                    </button>
                </div>
                
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Résumé -->
            <div class="modern-card sticky-top" style="top: 2rem;">
                <div class="card-header">
                    <h5 class="card-title mb-0 p-2"><i class="bi p-2 bi-calculator" style="color: black;"></i> Résumé</h5>
                </div>
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Nombre d'articles:</span>
                        <strong id="nb-articles">0</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Quantité totale:</span>
                        <strong id="quantite-totale">0</strong>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Sous-total HT:</span>
                        <span id="total-ht">0 FCFA</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <strong>Total TTC:</strong>
                        <strong class="text-success" id="total-ttc">0 FCFA</strong>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg m-3">
                            <i class="bi bi-check-circle" style="color: black;"></i>
                            {% if object %}Modifier{% else %}Créer{% endif %} l'Achat
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Aide -->
            <div class="modern-card mt-3">
                <div class="card-header">
                    <h5 class="card-title mb-0 p-2"><i class="bi p-2 bi-lightbulb" style="color: black;"></i> Aide</h5>
                </div>
                <div class="card-body p-3">
                    <ul class="list-unstyled small">
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success"></i>
                            Sélectionnez un fournisseur actif
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success"></i>
                            Le total se calcule automatiquement
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success"></i>
                            La quantité reçue peut être différente
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success"></i>
                            Les prix sont en Francs CFA
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Modal Nouveau Fournisseur -->
<div class="modal fade" id="fournisseurModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-building" style="color: black;"></i> Nouveau Fournisseur</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="fournisseurForm">
                    <div class="mb-3">
                        <label class="form-label">Nom du fournisseur *</label>
                        <input type="text" name="nom" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Personne de contact</label>
                        <input type="text" name="contact" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Téléphone</label>
                        <input type="tel" name="telephone" class="form-control" placeholder="+221 XX XXX XX XX">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="createFournisseur()">
                    <i class="bi bi-check-circle"></i> Créer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nouveau Produit -->
<div class="modal fade" id="produitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-box" style="color: black;"></i> Nouveau Produit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="produitForm">
                    <div class="mb-3">
                        <label class="form-label">Nom du produit *</label>
                        <input type="text" name="nom" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Catégorie *</label>
                        <select name="categorie" class="form-select" required>
                            <option value="">Sélectionner une catégorie</option>
                            {% for categorie in categories %}
                            <option value="{{ categorie.id }}">{{ categorie.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Prix d'achat</label>
                                <div class="input-group">
                                    <input type="number" name="prix_achat" class="form-control" step="0.01">
                                    <span class="input-group-text">FCFA</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Prix de vente *</label>
                                <div class="input-group">
                                    <input type="number" name="prix_vente" class="form-control" step="1" required>
                                    <span class="input-group-text">CFA</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Stock initial</label>
                        <input type="number" name="quantite_stock" class="form-control" value="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="createProduit()">
                    <i class="bi bi-check-circle"></i> Créer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let formCount = parseInt(document.querySelector('#id_form-TOTAL_FORMS').value);
    
    // Calcul automatique des totaux
    function calculateTotals() {
        let totalHT = 0;
        let nbArticles = 0;
        let quantiteTotale = 0;
        
        document.querySelectorAll('.formset-form').forEach(function(form) {
            const quantite = parseFloat(form.querySelector('[name$="-quantite"]').value) || 0;
            const prix = parseFloat(form.querySelector('[name$="-prix_unitaire"]').value) || 0;
            const total = quantite * prix;
            
            form.querySelector('.total-item').value = total.toLocaleString() + ' FCFA';
            
            if (quantite > 0 && prix > 0) {
                totalHT += total;
                nbArticles++;
                quantiteTotale += quantite;
            }
        });
        
        document.getElementById('nb-articles').textContent = nbArticles;
        document.getElementById('quantite-totale').textContent = quantiteTotale;
        document.getElementById('total-ht').textContent = totalHT.toLocaleString() + ' CFA';
        document.getElementById('total-ttc').textContent = totalHT.toLocaleString() + ' CFA';
    }
    
    // Événements pour recalcul automatique
    document.addEventListener('input', function(e) {
        if (e.target.name && (e.target.name.includes('quantite') || e.target.name.includes('prix_unitaire'))) {
            calculateTotals();
        }
    });
    
    // Ajouter un nouveau formulaire
    document.getElementById('add-form').addEventListener('click', function() {
        const container = document.getElementById('formset-container');
        const emptyForm = container.querySelector('.formset-form').cloneNode(true);
        
        // Nettoyer le nouveau formulaire
        emptyForm.querySelectorAll('input, select').forEach(function(input) {
            if (input.type !== 'hidden') {
                input.value = '';
            }
            input.name = input.name.replace(/-\d+-/, `-${formCount}-`);
            input.id = input.id.replace(/-\d+-/, `-${formCount}-`);
        });
        
        container.appendChild(emptyForm);
        formCount++;
        document.querySelector('#id_form-TOTAL_FORMS').value = formCount;
    });
    
    // Calcul initial
    calculateTotals();
});

// Créer un nouveau fournisseur
function createFournisseur() {
    const form = document.getElementById('fournisseurForm');
    const formData = new FormData(form);
    
    fetch('{% url "achats:fournisseur_quick_create" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Ajouter le nouveau fournisseur à la liste
            const select = document.getElementById('id_fournisseur');
            const option = new Option(data.fournisseur.nom, data.fournisseur.id);
            select.add(option);
            select.value = data.fournisseur.id;
            
            // Fermer la modal
            bootstrap.Modal.getInstance(document.getElementById('fournisseurModal')).hide();
            
            // Reset form
            form.reset();
            
            // Show success message
            showNotification('Fournisseur créé avec succès!', 'success');
        } else {
            showNotification('Erreur lors de la création', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Une erreur est survenue', 'danger');
    });
}

// Créer un nouveau produit
function createProduit() {
    const form = document.getElementById('produitForm');
    const formData = new FormData(form);
    
    fetch('{% url "produits:quick_create" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Ajouter le nouveau produit aux selects
            document.querySelectorAll('[name$="-produit"]').forEach(select => {
                const option = new Option(data.produit.nom, data.produit.id);
                select.add(option);
            });
            
            // Fermer la modal
            bootstrap.Modal.getInstance(document.getElementById('produitModal')).hide();
            
            // Reset form
            form.reset();
            
            // Show success message
            showNotification('Produit créé avec succès!', 'success');
        } else {
            showNotification('Erreur lors de la création', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Une erreur est survenue', 'danger');
    });
}

// Fonction de notification
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} notification`;
    notification.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
        ${message}
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}